<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erişkin Acil Nöbetmatik</title>
    
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        
        .cell-input { 
            width: 100%; height: 100%; text-align: center; background: transparent; 
            outline: none; font-size: 10px; font-weight: 700; white-space: pre-wrap; line-height: 1.1;
        }
        
        /* Yazıcı Dostu Konteyner */
        .print-container { 
            width: 100%; 
            font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: white;
            color: #1f2937;
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Tablo Stilleri */
        .th-cell { 
            font-size: 10px; 
            padding: 2px; 
            border: 1px solid #64748b; 
            text-align: center; 
            font-weight: 800; 
        }
        .td-cell { 
            border: 1px solid #94a3b8; 
            font-size: 10px; 
            height: 38px; 
            font-weight: 600;
            padding: 0;
            position: relative;
        }
        
        .weekend-bg { background-color: #ffedd5; } 

        /* Alan Renkleri */
        .bg-sari { background-color: #fef08a; color: #854d0e; } /* Sarı Alan */
        .bg-yesil { background-color: #bbf7d0; color: #14532d; } /* Yeşil Alan */
        .bg-triaj { background-color: #fecaca; color: #991b1b; } /* Triaj */
        .bg-kadin { background-color: #e9d5ff; color: #6b21a8; } /* Kadın Gözlem */
        .bg-erkek { background-color: #bfdbfe; color: #1e40af; } /* Erkek Gözlem */
        .bg-izin { background-color: #f3f4f6; color: #ef4444; } /* İzin */
        .bg-bos { background-color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Sabitler ve Veriler ---
        
        // Grup B (Sadece 8-16 tutanlar)
        const GROUP_B_NAMES = [
            "PINAR İLÇİN", "ÖZLEM BOZKURT", "NURCAN ÇİFTÇİ", "MERVE POYRAZ", 
            "CANSU ÖZEN", "BURCU KIYAK", "FATMA KIRTAŞ", "HÜLYA ŞAHİN", "SÜMEYYE KARAKAYA"
        ];

        // Grup A (Tüm nöbetleri tutanlar)
        const GROUP_A_NAMES = [
            "ABDURRAHMAN ŞAHİN", "AHMET ALTINTAŞ", "AHMET KAYA", "ALEYNA NUR ÇELİK", "ALİ İHSAN ÖZDEMİR",
            "ARZU BOZBOĞA", "ASENA ALBAYRAK", "AYŞE ÇETİN", "AYŞE SAN", "BURAKHAN KARAKAN",
            "BÜŞRA DEŞAT", "BÜŞRA KESKİN", "CANER KARAMAN", "CEREN CAN EMRE", "CUMALİ ORUÇ",
            "DÖNDÜ KARACA KOÇ", "EBRU TEKTAŞ", "EBUBEKİR BOZKURT", "ERDİ ŞEN", "ESRA KESKİN",
            "FATİH KÖYLÜ", "FUAT ÇOBAN", "GİZEM TÜRKER", "GONCA METİN", "GÖKHAN AKGÜL",
            "HACER AKYÜREK", "HATİCE EREN", "HİLAL KORUYAN", "İFAKET DUMLU", "KADİR KAYA",
            "KADRIYE ÖZKAN", "MERVE NUR DEMİRTAŞ", "MUHAMMED TATLI", "OKTAY KARAHAN", "ÖZGE KUŞ",
            "RABİA KAHRİMAN", "RABİA YAVAŞ KAYA", "RAMAZAN BİLGİN", "RECAİ KARAHAN", "REMZİYE YALMAN",
            "REMZİYE YATBAZ", "SELMA SERTELLİ", "SEMİHA ADIYAMAN", "SERHAT DURAK", "ŞAFAK TAŞTAN",
            "ŞAZİMET AYTEKİN", "ERDİ GÜREL", "TUĞBA DENİZ GÜREL", "VURAL GÜLEÇ", "YARENGÜZEL AŞÇI",
            "YASEMİN ERDEM", "YASİN KİRAZ", "YUNUS EMRE YILDIZ", "ZEHRA TEKBIÇAK"
        ];

        // Nöbet Tipleri ve Tanımları
        const SHIFT_ROLES = [
            { code: 'S-24', label: 'Sarı 24h', count: 4, hours: 24, type: 'A', class: 'bg-sari' },
            { code: 'KG-24', label: 'K.Göz 24h', count: 3, hours: 24, type: 'A', class: 'bg-kadin' },
            { code: 'EG-24', label: 'E.Göz 24h', count: 3, hours: 24, type: 'A', class: 'bg-erkek' },
            { code: 'T-24', label: 'Triaj 24h', count: 2, hours: 24, type: 'A', class: 'bg-triaj' },
            { code: 'Y-24', label: 'Yeşil 24h', count: 2, hours: 24, type: 'A', class: 'bg-yesil' },
            { code: 'T-16', label: 'Triaj 16h', count: 1, hours: 16, type: 'Any', class: 'bg-triaj' },
            { code: 'Y-16', label: 'Yeşil 16h', count: 1, hours: 16, type: 'Any', class: 'bg-yesil' },
            { code: 'T-08', label: 'Triaj 8h', count: 1, hours: 8, type: 'Any', class: 'bg-triaj' },
            { code: 'Y-08', label: 'Yeşil 8h', count: 1, hours: 8, type: 'Any', class: 'bg-yesil' }
        ];

        const MONTH_NAMES = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];
        const DAY_INITIALS = ["P", "P", "S", "Ç", "P", "C", "C"]; 

        const currentYear = new Date().getFullYear();
        const YEAR_OPTIONS = Array.from({length: 5}, (_, i) => currentYear + i);

        // --- Bileşenler ---

        const StaffItem = ({ person, onSave, onDelete }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempName, setTempName] = useState(person.name);

            useEffect(() => { setTempName(person.name); }, [person.name]);

            const handleSave = () => {
                if (tempName.trim()) {
                    onSave(person.name, tempName.toUpperCase()); 
                    setIsEditing(false);
                }
            };

            const groupColor = person.group === 'A' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700';
            const groupLabel = person.group === 'A' ? '24h' : '8/16h';

            if (isEditing) {
                return (
                    <div className="flex items-center space-x-1 bg-white p-1 rounded shadow border z-10 h-10">
                        <input 
                            type="text" value={tempName} onChange={(e) => setTempName(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleSave()}
                            className="flex-1 p-1 border rounded text-xs w-full font-bold" autoFocus
                        />
                        <button onClick={handleSave} className="bg-green-500 text-white w-6 h-6 rounded flex items-center justify-center"><i className="fas fa-check text-[10px]"></i></button>
                    </div>
                );
            }

            return (
                <div className="flex items-center space-x-2 bg-white border border-gray-200 p-1.5 rounded hover:shadow-md transition group h-10 cursor-pointer" onClick={() => setIsEditing(true)}>
                    <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded ${groupColor}`}>{groupLabel}</span>
                    <span className="text-xs font-bold text-gray-700 truncate select-none flex-1">{person.name}</span>
                    <button onClick={(e) => { e.stopPropagation(); onDelete(person.name); }} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><i className="fas fa-trash text-[10px]"></i></button>
                </div>
            );
        };

        function App() {
            // Başlangıçta personelleri birleştir
            const initialStaff = [
                ...GROUP_A_NAMES.map(n => ({ name: n, group: 'A' })),
                ...GROUP_B_NAMES.map(n => ({ name: n, group: 'B' }))
            ].sort((a, b) => a.name.localeCompare(b.name, 'tr'));

            const [staff, setStaff] = useState(initialStaff);
            const [inputYear, setInputYear] = useState(2026);
            const [inputMonth, setInputMonth] = useState(1);
            const [loadedDate, setLoadedDate] = useState(null); 
            const [daysInMonth, setDaysInMonth] = useState(28);
            const [constraints, setConstraints] = useState({}); 
            const [schedule, setSchedule] = useState({}); 
            const [stats, setStats] = useState({});
            const [activeTab, setActiveTab] = useState('settings'); 
            const [showClearConfirm, setShowClearConfirm] = useState(false); 
            const tableRef = useRef(null);

            useEffect(() => {
                const days = new Date(inputYear, inputMonth + 1, 0).getDate();
                setDaysInMonth(days);
            }, [inputYear, inputMonth]);

            useEffect(() => {
                calculateStats(schedule);
            }, [schedule, staff]); 

            // --- Yardımcı Fonksiyonlar ---
            const isWeekend = (year, month, day) => {
                const d = new Date(year, month, day);
                const dayIdx = d.getDay();
                return dayIdx === 0 || dayIdx === 6;
            };

            const getDayNameInitial = (year, month, day) => {
                const d = new Date(year, month, day);
                return DAY_INITIALS[d.getDay()];
            };

            const getDaysArray = () => Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const getResultDaysArray = () => {
                if (!loadedDate) return getDaysArray();
                const days = new Date(loadedDate.year, loadedDate.month + 1, 0).getDate();
                return Array.from({ length: days }, (_, i) => i + 1);
            };

            // Constraint İşlemleri
            const toggleConstraint = (personName, day) => {
                const key = `${personName}_${day}`;
                const current = constraints[key];
                const newConstraints = { ...constraints };
                if (!current) newConstraints[key] = 'X';      
                else if (current === 'X') newConstraints[key] = 'İ'; 
                else if (current === 'İ') newConstraints[key] = 'N'; 
                else delete newConstraints[key];
                setConstraints(newConstraints);
            };

            const clearConstraints = () => { setConstraints({}); setShowClearConfirm(false); };

            // İstatistik Hesaplama
            const calculateStats = (currentSchedule) => {
                const currentDays = loadedDate ? new Date(loadedDate.year, loadedDate.month + 1, 0).getDate() : daysInMonth;
                const newStats = {};
                
                staff.forEach(p => {
                    let totalHours = 0; 
                    let shiftCount = 0;
                    
                    for (let day = 1; day <= currentDays; day++) {
                        const key = `${p.name}_${day}`;
                        const val = currentSchedule[key];
                        if (val && val !== 'X' && val !== 'İ') {
                            shiftCount++;
                            // Kodu parçala (örn: "S-24")
                            const parts = val.split('-');
                            if (parts.length === 2 && !isNaN(parts[1])) {
                                totalHours += parseInt(parts[1]);
                            } else if (val === '24') { // Manuel giriş
                                totalHours += 24;
                            }
                        }
                    }
                    newStats[p.name] = { shiftCount, totalHours };
                });
                setStats(newStats);
            };

            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            // --- Ana Algoritma: Nöbet Dağıtımı ---
            const generateSchedule = () => {
                const targetDays = daysInMonth;
                const newSchedule = { ...constraints }; // Mevcut kısıtları koru
                
                // Personel durum takibi
                let staffState = {};
                staff.forEach(p => {
                    staffState[p.name] = { 
                        totalHours: 0, 
                        lastShiftDay: -10, 
                        group: p.group 
                    };
                });

                for (let day = 1; day <= targetDays; day++) {
                    const assignedToday = []; // Bugün nöbet yazılanlar

                    // 1. ADIM: Kısa Nöbetler (8h ve 16h) - Grup B Önceliği
                    const shortShifts = SHIFT_ROLES.filter(r => r.hours < 24);
                    
                    for (let role of shortShifts) {
                        for (let i = 0; i < role.count; i++) {
                            // Uygun adayları bul
                            let candidates = staff.filter(p => {
                                if (assignedToday.includes(p.name)) return false;
                                if (newSchedule[`${p.name}_${day}`] === 'X' || newSchedule[`${p.name}_${day}`] === 'İ') return false;
                                if (staffState[p.name].lastShiftDay === day - 1) return false; // Dün nöbet tuttuysa yazma
                                return true;
                            });

                            // Öncelikle Grup B'yi bu nöbetlere yönlendir
                            let priorityCandidates = candidates.filter(p => p.group === 'B');
                            
                            // Eğer Grup B'den kimse yoksa veya yetmezse Grup A'ya bak
                            if (priorityCandidates.length === 0) {
                                priorityCandidates = candidates.filter(p => p.group === 'A');
                            }

                            if (priorityCandidates.length > 0) {
                                // En az saati olana öncelik ver
                                priorityCandidates = shuffleArray(priorityCandidates);
                                priorityCandidates.sort((a, b) => staffState[a.name].totalHours - staffState[b.name].totalHours);
                                
                                const selected = priorityCandidates[0];
                                newSchedule[`${selected.name}_${day}`] = role.code;
                                assignedToday.push(selected.name);
                                staffState[selected.name].totalHours += role.hours;
                                staffState[selected.name].lastShiftDay = day;
                            }
                        }
                    }

                    // 2. ADIM: Uzun Nöbetler (24h) - Sadece Grup A
                    const longShifts = SHIFT_ROLES.filter(r => r.hours === 24);
                    
                    // Görev sırasını karıştır ki hep aynı kişiler Sarı Alana gitmesin
                    const randomizedLongShifts = [];
                    longShifts.forEach(role => {
                        for(let i=0; i<role.count; i++) randomizedLongShifts.push(role);
                    });
                    shuffleArray(randomizedLongShifts);

                    for (let role of randomizedLongShifts) {
                         let candidates = staff.filter(p => {
                            if (p.group !== 'A') return false; // Sadece Grup A
                            if (assignedToday.includes(p.name)) return false;
                            if (newSchedule[`${p.name}_${day}`] === 'X' || newSchedule[`${p.name}_${day}`] === 'İ') return false;
                            if (staffState[p.name].lastShiftDay >= day - 1) return false; // Dün nöbet tuttuysa yazma
                            return true;
                        });

                        if (candidates.length > 0) {
                            candidates = shuffleArray(candidates);
                            candidates.sort((a, b) => staffState[a.name].totalHours - staffState[b.name].totalHours);
                            
                            const selected = candidates[0];
                            newSchedule[`${selected.name}_${day}`] = role.code;
                            assignedToday.push(selected.name);
                            staffState[selected.name].totalHours += role.hours;
                            staffState[selected.name].lastShiftDay = day;
                        }
                    }
                }

                // İzinleri (İ) schedule'a işle
                staff.forEach(person => {
                   for (let day = 1; day <= targetDays; day++) {
                       const key = `${person.name}_${day}`;
                       if (constraints[key] === 'İ') newSchedule[key] = 'İ';
                   } 
                });

                setSchedule(newSchedule);
                setLoadedDate({ month: inputMonth, year: inputYear });
                setActiveTab('result');
            };

            const downloadImage = () => {
                if (tableRef.current && window.html2canvas) {
                    const originalTable = tableRef.current.querySelector('.print-container');
                    if (!originalTable) return;
                    
                    // Geçici klon oluştur
                    const clone = originalTable.cloneNode(true);
                    const targetWidth = 2000; // Daha geniş tablo için
                    clone.style.position = 'fixed'; 
                    clone.style.top = '-10000px'; 
                    clone.style.width = `${targetWidth}px`; 
                    clone.style.backgroundColor = 'white';
                    clone.style.padding = '20px';
                    
                    // Input değerlerini div'e çevir (html2canvas inputları bazen atlar)
                    const originalInputs = originalTable.querySelectorAll('input');
                    const clonedInputs = clone.querySelectorAll('input');
                    originalInputs.forEach((origInput, index) => {
                        const clonedInput = clonedInputs[index];
                        if (clonedInput) {
                            const div = document.createElement('div');
                            div.innerText = origInput.value;
                            div.className = origInput.className;
                            div.style.display = 'flex'; 
                            div.style.alignItems = 'center'; 
                            div.style.justifyContent = 'center';
                            if (clonedInput.parentNode) clonedInput.parentNode.replaceChild(div, clonedInput);
                        }
                    });

                    document.body.appendChild(clone);
                    window.html2canvas(clone, { scale: 1.5, useCORS: true, width: targetWidth, height: clone.scrollHeight + 50 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Eriskin_Acil_Nobet_${loadedDate ? loadedDate.month+1 : inputMonth+1}_${loadedDate ? loadedDate.year : inputYear}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.click();
                        document.body.removeChild(clone);
                    });
                }
            };

            const getCellClass = (val, isWeekend) => {
                if (!val) return isWeekend ? 'weekend-bg' : 'bg-bos';
                if (val === 'İ') return 'bg-izin text-red-600 font-bold';
                if (val === 'X') return 'bg-gray-100 text-gray-400 font-bold';
                
                const role = SHIFT_ROLES.find(r => r.code === val);
                if (role) return role.class;
                
                // Manuel girişler için fallback
                if (val.includes('24')) return 'bg-white text-black font-bold border-2 border-gray-800';
                return 'bg-blue-50';
            };

            const addStaff = () => {
                setStaff([...staff, { name: "YENİ PERSONEL", group: 'A' }]);
            };
            
            const removeStaff = (name) => {
                setStaff(staff.filter(s => s.name !== name));
            };
            
            const handleStaffUpdate = (oldName, newName) => {
                const updated = staff.map(s => s.name === oldName ? { ...s, name: newName } : s);
                updated.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
                setStaff(updated);
            };

            // --- Arayüz Parçaları ---
            
            const SettingsPanel = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-6 animate-fade-in">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Nöbet Ayarları</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">Yıl</label>
                            <select value={inputYear} onChange={(e)=>setInputYear(parseInt(e.target.value))} className="w-full border p-2 rounded">{YEAR_OPTIONS.map(y => (<option key={y} value={y}>{y}</option>))}</select>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">Ay</label>
                            <select value={inputMonth} onChange={(e)=>setInputMonth(parseInt(e.target.value))} className="w-full border p-2 rounded">{MONTH_NAMES.map((m,i)=>(<option key={i} value={i}>{m}</option>))}</select>
                        </div>
                        <div className="flex items-end">
                            <button onClick={() => setActiveTab('constraints')} className="w-full bg-teal-600 text-white py-2 px-4 rounded font-bold hover:bg-teal-700 transition shadow">
                                <i className="fas fa-calendar-alt mr-2"></i> İzinleri Gir & Başla
                            </button>
                        </div>
                    </div>

                    <div className="border-t pt-4">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-gray-700">Personel Listesi ({staff.length})</h3>
                            <div className="text-xs space-x-2">
                                <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded font-bold">Grup A: Tüm Nöbetler</span>
                                <span className="px-2 py-1 bg-purple-100 text-purple-800 rounded font-bold">Grup B: Sadece 8/16s</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 pr-1 custom-scroll max-h-[400px] overflow-y-auto">
                            {staff.map((p, i) => (
                                <StaffItem key={i} person={p} onSave={handleStaffUpdate} onDelete={removeStaff} />
                            ))}
                        </div>
                        <button onClick={addStaff} className="mt-4 w-full bg-gray-100 text-gray-700 py-2 rounded border hover:bg-gray-200 font-bold">+ Personel Ekle</button>
                    </div>
                </div>
            );

            const ConstraintGrid = () => (
                <div className="bg-white p-4 rounded-xl shadow-lg animate-fade-in border border-gray-100">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => setActiveTab('settings')} className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"><i className="fas fa-arrow-left mr-2"></i> Geri</button>
                        <h2 className="text-lg font-bold">Kısıtlamaları Giriniz (İzin / İstek)</h2>
                        <div className="flex gap-2">
                             <button onClick={() => setShowClearConfirm(true)} className="bg-red-100 text-red-600 px-3 py-1 rounded text-sm font-bold">Temizle</button>
                             {showClearConfirm && <button onClick={clearConstraints} className="bg-red-600 text-white px-3 py-1 rounded text-sm font-bold">Onayla</button>}
                        </div>
                    </div>
                    
                    <div className="overflow-x-auto border rounded shadow-inner max-h-[600px] custom-scroll">
                        <table className="min-w-full text-xs border-collapse">
                            <thead>
                                <tr className="bg-gray-800 text-white sticky top-0 z-20">
                                    <th className="p-2 border border-gray-600 w-48 text-left pl-3">Personel</th>
                                    {getDaysArray().map(d => (
                                        <th key={d} className={`p-1 border border-gray-600 w-8 ${isWeekend(inputYear, inputMonth, d) ? 'bg-orange-600' : ''}`}>
                                            <div className="flex flex-col"><span>{d}</span><span className="text-[8px] opacity-75">{getDayNameInitial(inputYear, inputMonth, d)}</span></div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {staff.map((p, idx) => (
                                    <tr key={p.name} className={idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                        <td className="p-1 border border-gray-300 font-semibold sticky left-0 bg-inherit z-10 pl-2 truncate">{p.name}</td>
                                        {getDaysArray().map(d => {
                                            const val = constraints[`${p.name}_${d}`];
                                            const isWe = isWeekend(inputYear, inputMonth, d);
                                            return (
                                                <td key={d} 
                                                    onClick={() => toggleConstraint(p.name, d)}
                                                    className={`border border-gray-300 cursor-pointer text-center select-none transition-colors ${getCellClass(val, isWe)} hover:opacity-80`}
                                                >
                                                    {val}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-4 flex justify-end">
                        <button onClick={generateSchedule} className="bg-green-600 text-white py-3 px-8 rounded-lg font-bold text-lg hover:bg-green-700 shadow-lg transform hover:scale-105 transition">
                            <i className="fas fa-magic mr-2"></i> LİSTEYİ OLUŞTUR
                        </button>
                    </div>
                </div>
            );

            const ResultView = () => (
                <div className="animate-fade-in">
                    <div className="bg-white p-4 rounded-xl shadow-lg mb-6 border border-gray-100">
                        <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setActiveTab('settings')} className="bg-gray-600 text-white py-2 px-3 rounded hover:bg-gray-700 text-sm"><i className="fas fa-home"></i></button>
                                <button onClick={() => setActiveTab('constraints')} className="bg-teal-600 text-white py-2 px-3 rounded hover:bg-teal-700 text-sm"><i className="fas fa-edit mr-1"></i> İzinler</button>
                                <h2 className="text-xl font-bold text-gray-800">Nöbet Listesi</h2>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={generateSchedule} className="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm font-bold shadow"><i className="fas fa-sync-alt mr-1"></i> Tekrar Dağıt</button>
                                <button onClick={downloadImage} className="bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 text-sm font-bold shadow"><i className="fas fa-download mr-1"></i> JPG İndir</button>
                            </div>
                        </div>

                        <div className="overflow-x-auto border rounded-lg bg-white shadow-inner" ref={tableRef}>
                            <div className="print-container p-6 min-w-[1400px]">
                                <div className="text-center mb-4 border-b-2 border-gray-800 pb-2">
                                    <h1 className="text-2xl font-black uppercase text-gray-900">ERİŞKİN ACİL SERVİS NÖBET ÇİZELGESİ</h1>
                                    <h3 className="text-lg text-gray-700 font-bold uppercase">{MONTH_NAMES[loadedDate?.month || inputMonth]} {loadedDate?.year || inputYear}</h3>
                                </div>
                                
                                <table className="w-full border-collapse border border-gray-800 table-fixed">
                                    <thead>
                                        <tr className="bg-gray-800 text-white">
                                            <th className="th-cell w-40 text-left pl-2">PERSONEL</th>
                                            {getResultDaysArray().map(d => (
                                                <th key={d} className={`th-cell w-8 ${isWeekend(loadedDate?.year || inputYear, loadedDate?.month || inputMonth, d) ? 'bg-orange-600' : ''}`}>
                                                    <div className="flex flex-col"><span>{d}</span><span className="text-[8px] font-normal opacity-80">{getDayNameInitial(loadedDate?.year || inputYear, loadedDate?.month || inputMonth, d)}</span></div>
                                                </th>
                                            ))}
                                            <th className="th-cell w-10 bg-gray-200 text-black">Nöb.</th>
                                            <th className="th-cell w-10 bg-gray-200 text-black">Saat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {staff.map((p, idx) => (
                                            <tr key={p.name} className={idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                                <td className="td-cell pl-2 border-gray-400 text-gray-900 truncate" title={p.name}>{p.name}</td>
                                                {getResultDaysArray().map(d => {
                                                    const key = `${p.name}_${d}`;
                                                    const val = schedule[key] || '';
                                                    const isWe = isWeekend(loadedDate?.year || inputYear, loadedDate?.month || inputMonth, d);
                                                    
                                                    return (
                                                        <td key={d} className={`td-cell border-gray-400 ${getCellClass(val, isWe)}`}>
                                                            <input 
                                                                className={`cell-input ${val && val.length > 3 ? 'text-[9px]' : 'text-xs'}`} 
                                                                value={val} 
                                                                onChange={(e) => {
                                                                    const newVal = e.target.value.toUpperCase();
                                                                    const newSched = {...schedule, [key]: newVal};
                                                                    setSchedule(newSched);
                                                                    calculateStats(newSched);
                                                                }} 
                                                            />
                                                        </td>
                                                    );
                                                })}
                                                <td className="td-cell text-center bg-gray-100 border-gray-400 font-bold">{stats[p.name]?.shiftCount || 0}</td>
                                                <td className="td-cell text-center bg-gray-100 border-gray-400 font-bold">{stats[p.name]?.totalHours || 0}</td>
                                            </tr>
                                        ))}
                                        {/* Günlük Toplam Kontrolü */}
                                        <tr className="bg-gray-800 text-white font-bold h-8">
                                            <td className="text-right pr-2 text-xs">DOLULUK:</td>
                                            {getResultDaysArray().map(d => {
                                                let count = 0;
                                                staff.forEach(p => { 
                                                    const v = schedule[`${p.name}_${d}`];
                                                    if (v && v !== 'X' && v !== 'İ') count++; 
                                                });
                                                const expected = 18; // 14 (24h) + 4 (Short)
                                                const color = count === expected ? 'text-green-400' : 'text-red-400';
                                                return <td key={d} className={`text-center text-[10px] border border-gray-600 ${color}`}>{count}</td>;
                                            })}
                                            <td colSpan="2"></td>
                                        </tr>
                                    </tbody>
                                </table>

                                {/* Renk Lejandı */}
                                <div className="mt-4 flex flex-wrap justify-center gap-3 text-[10px] font-bold uppercase">
                                    <div className="flex items-center border p-1 rounded bg-sari w-24 justify-center">SARI (24h)</div>
                                    <div className="flex items-center border p-1 rounded bg-kadin w-24 justify-center">K.GÖZ (24h)</div>
                                    <div className="flex items-center border p-1 rounded bg-erkek w-24 justify-center">E.GÖZ (24h)</div>
                                    <div className="flex items-center border p-1 rounded bg-triaj w-24 justify-center">TRİAJ</div>
                                    <div className="flex items-center border p-1 rounded bg-yesil w-24 justify-center">YEŞİL</div>
                                    <div className="flex items-center border p-1 rounded bg-izin w-24 justify-center">İZİNLİ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="max-w-full mx-auto p-2 min-h-screen">
                    {activeTab === 'settings' && <SettingsPanel />}
                    {activeTab === 'constraints' && <ConstraintGrid />}
                    {activeTab === 'result' && <ResultView />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>